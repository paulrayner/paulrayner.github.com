
    <div id="page-navigation">
            <div class="clear">&nbsp;</div>
            <div class="left" width="100">
            {% if page.previous.url %}
                    <a href="{{page.previous.url}}" title="Previous Post:
    {{page.previous.title}}">&laquo; {{page.previous.title}}</a>
            {% endif %}
            </div>

            <div class="right">
            {% if page.next.url %}
                    <a href="{{page.next.url}}" title="next Post:
    {{page.next.title}}">{{page.next.title}} &raquo; </a>
            {% endif %}
            </div>
            <div class="clear">&nbsp;</div>
            <div class="clear">&nbsp;</div>
            <br>

            <h3>Related Posts</h3>

            <ul>
              {% assign related_posts = '' | split: '' %}
              {% assign max_related = 10 %}
              
              <!-- First priority: posts with shared tags -->
              {% if page.tags.size > 0 %}
                {% for post in site.posts %}
                  {% if post.url != page.url %}
                    {% assign common_tags = 0 %}
                    {% for tag in post.tags %}
                      {% if page.tags contains tag %}
                        {% assign common_tags = common_tags | plus: 1 %}
                      {% endif %}
                    {% endfor %}
                    {% if common_tags > 0 %}
                      {% assign related_posts = related_posts | push: post %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
              {% endif %}
              
              <!-- If we don't have enough related posts, fill with recent posts -->
              {% if related_posts.size < max_related %}
                {% assign posts_needed = max_related | minus: related_posts.size %}
                {% for post in site.posts limit: posts_needed %}
                  {% unless related_posts contains post or post.url == page.url %}
                    {% assign related_posts = related_posts | push: post %}
                  {% endunless %}
                {% endfor %}
              {% endif %}
              
              <!-- Display the related posts -->
              {% for post in related_posts limit: max_related %}
                <li>
                  <a href="{{ post.url }}">{{ post.title }}</a>
                </li>
              {% endfor %}
            </ul>
    </div>
